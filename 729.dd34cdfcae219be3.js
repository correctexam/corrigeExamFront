(()=>{"use strict";var l,we={18544:(l,z,o)=>{var G=o(15861),b=o(65500),E=o(7715),A=o(92438),ee=o(37398),x=o(58906),te=o(76328),j=o(48857);var Ae=o(65592),xe=o(82384);let be;const Me=new Map;class Ce{examName;db;constructor(e){this.examName=e}error(...e){console.error(...e)}initDb(e){if(void 0===this.db||!this.db.isOpen()){const t=e.oo1;this.db=e.opfs?new t.OpfsDb("/"+this.examName+".sqlite3"):new t.DB("/"+this.examName+".sqlite3","ct")}}close(){this.db.close()}initemptyDb(e){this.initDb(e);try{this.db.exec("CREATE TABLE IF NOT EXISTS template(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS align(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS nonalign(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)")}finally{this.close()}}getFirstNonAlignImage(e,t){this.initDb(e);try{return this.db.selectValue("select imageData from nonalign where page="+t)}finally{this.close()}}}!function ne(H){const e=new H,t=(0,A.R)(self,"message");return function ye(H,e){const t=e.pipe((0,ee.U)(a=>new b.P_(a.data.kind,a.data.value,a.data.error)),(0,x.D)());return function M(H){return!!H.workUnit}(H)?t.pipe((0,te.b)(a=>(0,E.D)(H.workUnit(a)).pipe((0,j.i)()))):H.work(t).pipe((0,j.i)())}(e,t).subscribe(a=>{const s=postMessage;(function u(H){return!!H.selectTransferables})(e)&&a.hasValue?s(a,e.selectTransferables(a.value)):s(a)})}(class ze{opencvready=new Promise(e=>{const t=self;t.Module={scriptUrl:"content/opencv/5/opencv.js",onRuntimeInitialized(){cv.then(a=>{cv=a,cv.ready.then(()=>{e()}).catch(s=>{console.log(s)})})}},t.importScripts(t.Module.scriptUrl)});db;initSqlLite=!1;sqlliteReady=e=>new Promise(e?t=>{const a=self;a.Module={scriptUrl:"content/sqlite/sqlite3.js"},a.importScripts(a.Module.scriptUrl),a.sqlite3InitModule({print:console.log,printErr:console.error}).then(function(s){be=s,t()}).catch(s=>{console.log(s)})}:t=>{t()});reviver(e,t){return"object"==typeof t&&null!==t&&"Map"===t.dataType?new Map(t.value):t}loadImage(e){var t=this;return(0,G.Z)(function*(){const a=JSON.parse(e.value,t.reviver),c=yield(yield fetch(a.pages)).blob(),m=yield createImageBitmap(c),F=new OffscreenCanvas(m.width,m.height).getContext("2d");return F.drawImage(m,0,0),F.getImageData(0,0,m.width,m.height)})()}getScanImage(e,t,a){var s=this;return(0,G.Z)(function*(){if(a)return void 0===s.db&&(s.db=new xe.z),yield s.db.getFirstNonAlignImage(t,e);{let c=Me.get(t);return void 0===c&&(c=new Ce(t),Me.set(t,c)),{examId:t,pageNumber:e,value:c.getFirstNonAlignImage(be,e)}}})()}workUnit(e){var t=this;return new Ae.y(a=>{this.opencvready.then((0,G.Z)(function*(){!e.indexDb&&!t.initSqlLite&&(yield t.sqlliteReady(!e.indexDb),t.initSqlLite=!0);let s=yield t.getScanImage(e.pageNumber,e.examId,e.indexDb);if(void 0!==s){const c=yield t.loadImage(s);if(s=void 0,e.marker){const m=t.alignImageBasedOnCircle(e.imageA,c,e.widthA,e.heightA,e.preference,e.debug);m.pageNumber=e.pageNumber,a.next(m),a.complete()}else try{const m=t.alignImage(e.imageA,c,e.widthA,e.heightA,!1,e.preference.numberofpointToMatch,e.preference.numberofpointToMatch,e.debug);e.imageA=void 0,m.pageNumber=e.pageNumber,a.next(m),a.complete()}catch(m){console.error(m)}}})).catch(s=>{console.log(s)})})}selectTransferables(e){return void 0!==e.imagesDebugTraces?[e.imageAligned,e.imagesDebugTraces]:[e.imageAligned]}imageDataFromMat(e){const t=e,a=e.type()%8,s=a<=cv.CV_8S?1:a<=cv.CV_32S?1/256:255,c=a===cv.CV_8S||a===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,s,c),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const m=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return e.delete(),m}roi(e,t){const a=e.size().width,s=e.size().height;return t.x+t.width>a&&(t.width=a-t.x),t.y+t.height>s&&(t.height=s-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}alignImage(e,t,a,s,c,m,T,F){const Y=new ImageData(new Uint8ClampedArray(e),a,s),v=t,n=cv.matFromImageData(Y);let $=cv.matFromImageData(v),Z=$;if(n.size().width!==$.size().width||n.size().height!==$.size().height){Z=new cv.Mat;let i=new cv.Size(n.size().width,n.size().height);cv.resize($,Z,i,0,0,cv.INTER_AREA),$.delete()}let I=new cv.Mat,_=new cv.Mat;cv.cvtColor(Z,I,cv.COLOR_BGRA2GRAY),cv.cvtColor(n,_,cv.COLOR_BGRA2GRAY);const X=Math.trunc(n.size().width/10);let C=[],V=[],y={},W=!1,k=!1,d=!1,f=!1;const R=Math.min(I.size().width,_.size().width),q=Math.min(I.size().height,_.size().height);if(c){let i=new cv.Rect(0,0,R,q);W=this.matchSmallImage(I,_,C,V,i,m,T),k=!0,d=!0,f=!0}else{let i=X;for(;!W&&i<3*R/4&&i<2*q/3;){let O=new cv.Rect(0,0,i,i);W=this.matchSmallImage(I,_,C,V,O,m,T),W||(i+=Math.trunc(R/10))}for(i=X;!k&&i<3*R/4&&i<2*q/3;){let O=new cv.Rect(R-i,0,R,i);k=this.matchSmallImage(I,_,C,V,O,m,T),k||(i+=Math.trunc(R/10))}for(i=X;!d&&i<3*R/4&&i<2*q/3;){let O=new cv.Rect(0,q-i,i,q);d=this.matchSmallImage(I,_,C,V,O,m,T),d||(i+=Math.trunc(R/10))}for(i=X;!f&&i<3*R/4&&i<2*q/3;){let O=new cv.Rect(R-i,q-i,R,q);f=this.matchSmallImage(I,_,C,V,O,m,T),f||(i+=Math.trunc(R/10))}}if(W&&k&&d&&f){let i=cv.matFromArray(C.length/2,1,cv.CV_32FC2,C),O=cv.matFromArray(V.length/2,1,cv.CV_32FC2,V),ie=cv.findHomography(i,O,cv.RANSAC),L=Z;if(cv.warpPerspective(L,L,ie,n.size()),F){let N=new cv.MatVector;N.push_back(n),N.push_back(Z);let r=new cv.Mat;cv.hconcat(N,r);const U=V.length/2;for(let B=0;B<U;B++){let h={x:V[2*B],y:V[2*B+1]},P={x:n.size().width+C[2*B],y:C[2*B+1]};cv.circle(r,h,5,[0,255,0,255],1),cv.circle(r,P,5,[0,255,0,255],1),cv.line(r,h,P,[0,255,0,255],1)}y.imagesDebugTracesWidth=r.size().width,y.imagesDebugTracesHeight=r.size().height,y.imagesDebugTraces=this.imageDataFromMat(r).data.buffer,N.delete()}y.imageAlignedWidth=L.size().width,y.imageAlignedHeight=L.size().height,y.imageAligned=this.imageDataFromMat(L).data.buffer,i.delete(),O.delete(),ie.delete(),t.data.set([])}else{if(F){let i=new cv.MatVector;i.push_back(n),i.push_back(Z);let O=new cv.Mat;cv.hconcat(i,O),y.imagesDebugTracesWidth=O.size().width,y.imagesDebugTracesHeight=O.size().height,y.imagesDebugTraces=this.imageDataFromMat(O).data.buffer,i.delete()}y.imageAligned=t.data.buffer,y.imageAlignedWidth=t.width,y.imageAlignedHeight=t.height,Z.delete()}return Y.data.set([]),n.delete(),I.delete(),_.delete(),y}matchSmallImage(e,t,a,s,c,m,T){let F=new cv.Mat;F=this.roi(e,c);let Y=new cv.Mat;Y=this.roi(t,c);let v=new cv.KeyPointVector,n=new cv.KeyPointVector,$=new cv.Mat,Z=new cv.Mat,I=new cv.AKAZE,X=Y;I.detectAndCompute(F,F,v,$),I.detectAndCompute(Y,X,n,Z);const C=F.size().width,V=F.size().height;F.delete(),Y.delete(),I.delete();let y=new cv.DMatchVector,W=new cv.BFMatcher,k=new cv.DMatchVectorVector;W.knnMatch($,Z,k,2),$.delete(),Z.delete();for(let r=0;r<k.size();++r){let U=k.get(r),B=U.get(0),h=U.get(1);void 0!==B&&void 0!==h&&B.distance<=h.distance*parseFloat("0.7")&&y.push_back(B)}if(0===y.size())return v.delete(),n.delete(),k.delete(),y.delete(),W.delete(),!1;let d=[],f=[];for(let r=0;r<y.size();r++)d.push(v.get(y.get(r).queryIdx).pt.x+c.x),d.push(v.get(y.get(r).queryIdx).pt.y+c.y),f.push(n.get(y.get(r).trainIdx).pt.x+c.x),f.push(n.get(y.get(r).trainIdx).pt.y+c.y);let R=0,q=[];const i=[];for(let r=0;r<y.size();r++){let U=(d[2*r]-f[2*r])*(d[2*r]-f[2*r])+(d[2*r+1]-f[2*r+1])*(d[2*r+1]-f[2*r+1]);U<Math.trunc(3*C/20)*Math.trunc(3*V/20)&&(q.push(U),R+=1,i.push(r))}const O=this.numAverage(q);let ie=this.dev(q);if(ie<1&&(ie=1),R<=m)return v.delete(),n.delete(),k.delete(),y.delete(),W.delete(),!1;let L=0,N=[];for(let r=0;r<i.length;r++){let U=(d[2*i[r]]-f[2*i[r]])*(d[2*i[r]]-f[2*i[r]])+(d[2*i[r]+1]-f[2*i[r]+1])*(d[2*i[r]+1]-f[2*i[r]+1]);U<=O+1*ie&&U>=O-1*ie&&(L+=1,N.push(i[r]))}if(L<=T)return v.delete(),n.delete(),k.delete(),y.delete(),W.delete(),!1;{const r=[],U=[];N.forEach(h=>{U.push((d[2*h]-f[2*h])*(d[2*h]-f[2*h])+(d[2*h+1]-f[2*h+1])*(d[2*h+1]-f[2*h+1]))});const B=this.numAverage(U);return N.sort((h,P)=>Math.abs((d[2*h]-f[2*h])*(d[2*h]-f[2*h])+(d[2*h+1]-f[2*h+1])*(d[2*h+1]-f[2*h+1])-B)-Math.abs((d[2*P]-f[2*P])*(d[2*P]-f[2*P])+(d[2*P+1]-f[2*P+1]*(d[2*P+1]-f[2*P+1]))-B)),r.push(N[0]),r.push(N[1]),r.push(N[2]),r.push(N[3]),r.push(N[4]),r.forEach(h=>{a.push(v.get(y.get(+h).queryIdx).pt.x+c.x),a.push(v.get(y.get(+h).queryIdx).pt.y+c.y),s.push(n.get(y.get(+h).trainIdx).pt.x+c.x),s.push(n.get(y.get(+h).trainIdx).pt.y+c.y)}),v.delete(),n.delete(),k.delete(),y.delete(),W.delete(),!0}}numAverage(e){return e.reduce((t,a)=>t+a,0)/e.length}dev(e){let t=e.reduce((s,c)=>s+c,0)/e.length,a=(e=e.map(s=>(s-t)**2)).reduce((s,c)=>s+c,0);return Math.sqrt(a/e.length)}alignImageBasedOnCircle(e,t,a,s,c,m){const T=new ImageData(new Uint8ClampedArray(e),a,s),F=t;let I,_,X,C,V,y,W,k,d,f,R,q,Y=cv.matFromImageData(T),v=new cv.Mat,n=new cv.Mat;cv.cvtColor(Y,v,cv.COLOR_RGBA2GRAY),cv.HoughCircles(v,n,cv.HOUGH_GRADIENT,1,45,75,20,v.cols*c.minCircle/1e3,v.cols*c.maxCircle/1e3),n.cols>0&&(I=n.data32F[0],_=n.data32F[1],X=n.data32F[2],C=n.data32F[0],V=n.data32F[1],y=n.data32F[2],W=n.data32F[0],k=n.data32F[1],d=n.data32F[2],f=n.data32F[0],R=n.data32F[1],q=n.data32F[2]);const i=v.size().width,O=v.size().height;if(n.cols>0)for(let S=1;S<n.cols;S++){let p=n.data32F[3*S],w=n.data32F[3*S+1],ae=n.data32F[3*S+2];p*p+w*w<=I*I+_*_&&(I=p,_=w,X=ae),p*p+w*w>=f*f+R*R&&(f=p,R=w,q=ae),(i-p)*(i-p)+w*w<=(i-C)*(i-C)+V*V&&(C=p,V=w,y=ae),p*p+(O-w)*(O-w)<=W*W+(O-k)*(O-k)&&(W=p,k=w,d=ae)}let ie=cv.matFromImageData(F),L=ie;if(L.size().width!==v.size().width||L.size().height!==v.size().height){L=new cv.Mat;let S=new cv.Size(v.size().width,v.size().height);cv.resize(ie,L,S,0,0,cv.INTER_AREA),ie.delete()}let N=new cv.Mat,r=new cv.Mat;cv.cvtColor(L,N,cv.COLOR_RGBA2GRAY);const U=N.size().width,B=N.size().height;cv.HoughCircles(N,r,cv.HOUGH_GRADIENT,1,45,75,15,d-3,d+3);let h=[],P=[];const Te=180*(4*d*d-3.14159*d*d)/100;for(let S=0;S<r.cols;S++){let p=r.data32F[3*S],w=r.data32F[3*S+1];const ae=p-d,le=w-d;let re=2*d,J=2*d;ae+re>U&&(re=U-ae),le+J>B&&(J=B-le);let pe=new cv.Rect(p-d,w-d,re,J),D=new cv.Mat,K=new cv.Mat;D=this.roi(N,pe),cv.threshold(D,K,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(K)<Te&&(h.push(p),P.push(w)),K.delete(),D.delete()}let ce,oe,de,he,ue,ge,fe,me;if(h.length>0&&(ce=h[0],oe=P[0],de=h[0],he=P[0],ue=h[0],ge=P[0],fe=h[0],me=P[0]),h.length>1)for(let S=0;S<h.length;S++){let p=h[S],w=P[S];p*p+w*w<=ce*ce+oe*oe&&(ce=p,oe=w),p*p+w*w>=fe*fe+me*me&&(fe=p,me=w),(U-p)*(U-p)+w*w<=(U-de)*(U-de)+he*he&&(de=p,he=w),p*p+(B-w)*(B-w)<=ue*ue+(B-ge)*(B-ge)&&(ue=p,ge=w)}if(h.length>=4){let S=cv.matFromArray(4,1,cv.CV_32FC2,[I,_,C,V,W,k,f,R]),p=cv.matFromArray(4,1,cv.CV_32FC2,[ce,oe,de,he,ue,ge,fe,me]),w=cv.getPerspectiveTransform(p,S),ae=new cv.Size(v.cols,v.rows);for(let J=0;J<S.rows;++J){let K=15,Q=new cv.Point(p.data32F[2*J],p.data32F[2*J+1]);cv.circle(L,Q,K,[0,0,255,255],1)}let le=L;cv.warpPerspective(L,le,w,ae,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let re={};if(m){let J=new cv.MatVector;J.push_back(Y),J.push_back(L);let pe=new cv.Size(2*Y.size().width,v.size().height),D=new cv.Mat(pe,Y.type());cv.hconcat(J,D);let K={x:I,y:_},Q={x:v.size().width+ce,y:oe};cv.circle(D,K,15,[0,255,0,255],1),cv.circle(D,Q,15,[0,255,0,255],1),cv.line(D,K,Q,[0,255,0,255],1),K={x:C,y:V},Q={x:v.size().width+de,y:he},cv.circle(D,K,15,[0,255,0,255],1),cv.circle(D,Q,15,[0,255,0,255],1),cv.line(D,K,Q,[0,255,0,255],1),K={x:W,y:k},Q={x:v.size().width+ue,y:ge},cv.circle(D,K,15,[0,255,0,255],1),cv.circle(D,Q,15,[0,255,0,255],1),cv.line(D,K,Q,[0,255,0,255],1),K={x:f,y:R},Q={x:v.size().width+fe,y:me},cv.circle(D,K,15,[0,255,0,255],1),cv.circle(D,Q,15,[0,255,0,255],1),cv.line(D,K,Q,[0,255,0,255],1),re.imagesDebugTracesWidth=D.size().width,re.imagesDebugTracesHeight=D.size().height,re.imagesDebugTraces=this.imageDataFromMat(D).data.buffer,J.delete()}return re.imageAlignedWidth=le.size().width,re.imageAlignedHeight=le.size().height,re.imageAligned=this.imageDataFromMat(le).data.buffer,Y.delete(),v.delete(),n.delete(),N.delete(),r.delete(),S.delete(),p.delete(),w.delete(),re}return Y.delete(),v.delete(),n.delete(),N.delete(),L.delete(),r.delete(),this.alignImage(e,t,a,s,!1,c.numberofpointToMatch,c.numberofgoodpointToMatch,m)}})},55113:(l,z,o)=>{o.d(z,{Nn:()=>x,w0:()=>A});var G=o(84674),b=o(59732),E=o(49039);class A{constructor(u){this.initialTeardown=u,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let u;if(!this.closed){this.closed=!0;const{_parentage:M}=this;if(M)if(this._parentage=null,Array.isArray(M))for(const se of M)se.remove(this);else M.remove(this);const{initialTeardown:ye}=this;if((0,G.m)(ye))try{ye()}catch(se){u=se instanceof b.B?se.errors:[se]}const{_finalizers:ne}=this;if(ne){this._finalizers=null;for(const se of ne)try{te(se)}catch(ve){u=u??[],ve instanceof b.B?u=[...u,...ve.errors]:u.push(ve)}}if(u)throw new b.B(u)}}add(u){var M;if(u&&u!==this)if(this.closed)te(u);else{if(u instanceof A){if(u.closed||u._hasParent(this))return;u._addParent(this)}(this._finalizers=null!==(M=this._finalizers)&&void 0!==M?M:[]).push(u)}}_hasParent(u){const{_parentage:M}=this;return M===u||Array.isArray(M)&&M.includes(u)}_addParent(u){const{_parentage:M}=this;this._parentage=Array.isArray(M)?(M.push(u),M):M?[M,u]:u}_removeParent(u){const{_parentage:M}=this;M===u?this._parentage=null:Array.isArray(M)&&(0,E.P)(M,u)}remove(u){const{_finalizers:M}=this;M&&(0,E.P)(M,u),u instanceof A&&u._removeParent(this)}}function x(j){return j instanceof A||j&&"closed"in j&&(0,G.m)(j.remove)&&(0,G.m)(j.add)&&(0,G.m)(j.unsubscribe)}function te(j){(0,G.m)(j)?j():j.unsubscribe()}A.EMPTY=(()=>{const j=new A;return j.closed=!0,j})()},79940:(l,z,o)=>{o.d(z,{yG:()=>A});var G=o(50671);function A(x){return(0,G.K)(function b(x){return x[x.length-1]}(x))?x.pop():void 0}},79360:(l,z,o)=>{o.d(z,{e:()=>E});var G=o(84674);function E(A){return ee=>{if(function b(A){return(0,G.m)(A?.lift)}(ee))return ee.lift(function(x){try{return A(x,this)}catch(te){this.error(te)}});throw new TypeError("Unable to lift unknown Observable type")}}}},_e={};function g(l){var z=_e[l];if(void 0!==z)return z.exports;var o=_e[l]={exports:{}};return we[l].call(o.exports,o,o.exports,g),o.exports}g.m=we,g.x=()=>{var l=g.O(void 0,[173,379,592],()=>g(18544));return g.O(l)},l=[],g.O=(z,o,G,b)=>{if(!o){var A=1/0;for(E=0;E<l.length;E++){for(var[o,G,b]=l[E],ee=!0,x=0;x<o.length;x++)(!1&b||A>=b)&&Object.keys(g.O).every(ne=>g.O[ne](o[x]))?o.splice(x--,1):(ee=!1,b<A&&(A=b));if(ee){l.splice(E--,1);var te=G();void 0!==te&&(z=te)}}return z}b=b||0;for(var E=l.length;E>0&&l[E-1][2]>b;E--)l[E]=l[E-1];l[E]=[o,G,b]},g.d=(l,z)=>{for(var o in z)g.o(z,o)&&!g.o(l,o)&&Object.defineProperty(l,o,{enumerable:!0,get:z[o]})},g.f={},g.e=l=>Promise.all(Object.keys(g.f).reduce((z,o)=>(g.f[o](l,z),z),[])),g.u=l=>(592===l?"common":l)+"."+{173:"f188109f3619c2fc",379:"5a2571747190c487",592:"21391bcc31b2b0ae"}[l]+".js",g.miniCssF=l=>{},g.o=(l,z)=>Object.prototype.hasOwnProperty.call(l,z),g.j=729,(()=>{var l;g.tt=()=>(void 0===l&&(l={createScriptURL:z=>z},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(l=trustedTypes.createPolicy("angular#bundler",l))),l)})(),g.tu=l=>g.tt().createScriptURL(l),g.p="",(()=>{var l={729:1};g.f.i=(b,E)=>{l[b]||importScripts(g.tu(g.p+g.u(b)))};var o=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],G=o.push.bind(o);o.push=b=>{var[E,A,ee]=b;for(var x in A)g.o(A,x)&&(g.m[x]=A[x]);for(ee&&ee(g);E.length;)l[E.pop()]=1;G(b)}})(),(()=>{var l=g.x;g.x=()=>Promise.all([173,379,592].map(g.e,g)).then(l)})(),g.x()})();