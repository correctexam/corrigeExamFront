(()=>{"use strict";var c,Ce={18544:(c,T,o)=>{var U=o(15861),M=o(65500),I=o(7715),C=o(92438),X=o(37398),x=o(58906),Q=o(76328),H=o(48857);var Re=o(65592),Fe=o(82384);let ze;const Te=new Map;class Ee{examName;db;constructor(e){this.examName=e}error(...e){console.error(...e)}initDb(e){if(void 0===this.db||!this.db.isOpen()){const t=e.oo1;this.db=e.opfs?new t.OpfsDb("/"+this.examName+".sqlite3"):new t.DB("/"+this.examName+".sqlite3","ct")}}close(){this.db.close()}initemptyDb(e){this.initDb(e);try{this.db.exec("CREATE TABLE IF NOT EXISTS template(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS align(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)"),this.db.exec("CREATE TABLE IF NOT EXISTS nonalign(page INTEGER NOT NULL PRIMARY KEY,imageData CLOB NOT NULL)")}finally{this.close()}}getFirstNonAlignImage(e,t){this.initDb(e);try{return this.db.selectValue("select imageData from nonalign where page="+t)}finally{this.close()}}}!function ve(G){const e=new G,t=(0,C.R)(self,"message");return function Me(G,e){const t=e.pipe((0,X.U)(a=>new M.P_(a.data.kind,a.data.value,a.data.error)),(0,x.D)());return function A(G){return!!G.workUnit}(G)?t.pipe((0,Q.b)(a=>(0,I.D)(G.workUnit(a)).pipe((0,H.i)()))):G.work(t).pipe((0,H.i)())}(e,t).subscribe(a=>{const s=postMessage;(function h(G){return!!G.selectTransferables})(e)&&a.hasValue?s(a,e.selectTransferables(a.value)):s(a)})}(class Oe{opencvready=new Promise(e=>{const t=self;t.Module={scriptUrl:"content/opencv/5/opencv.js",onRuntimeInitialized(){cv.then(a=>{cv=a,cv.ready.then(()=>{e()}).catch(s=>{console.log(s)})})}},t.importScripts(t.Module.scriptUrl)});db;initSqlLite=!1;sqlliteReady=e=>new Promise(e?t=>{const a=self;a.Module={scriptUrl:"content/sqlite/sqlite3.js"},a.importScripts(a.Module.scriptUrl),a.sqlite3InitModule({print:console.log,printErr:console.error}).then(function(s){ze=s,t()}).catch(s=>{console.log(s)})}:t=>{t()});reviver(e,t){return"object"==typeof t&&null!==t&&"Map"===t.dataType?new Map(t.value):t}loadImage(e){var t=this;return(0,U.Z)(function*(){const a=JSON.parse(e.value,t.reviver),l=yield(yield fetch(a.pages)).blob(),f=yield createImageBitmap(l),S=new OffscreenCanvas(f.width,f.height).getContext("2d");return S.drawImage(f,0,0),S.getImageData(0,0,f.width,f.height)})()}getScanImage(e,t,a){var s=this;return(0,U.Z)(function*(){if(a)return void 0===s.db&&(s.db=new Fe.z),yield s.db.getFirstNonAlignImage(t,e);{let l=Te.get(t);return void 0===l&&(l=new Ee(t),Te.set(t,l)),{examId:t,pageNumber:e,value:l.getFirstNonAlignImage(ze,e)}}})()}workUnit(e){var t=this;return new Re.y(a=>{this.opencvready.then((0,U.Z)(function*(){!e.indexDb&&!t.initSqlLite&&(yield t.sqlliteReady(!e.indexDb),t.initSqlLite=!0);let s=yield t.getScanImage(e.pageNumber,e.examId,e.indexDb);if(void 0!==s){const l=yield t.loadImage(s);if(s=void 0,e.marker){const f=t.alignImageBasedOnCircle(e.imageA,l,e.widthA,e.heightA,e.preference,e.debug);f.pageNumber=e.pageNumber,a.next(f),a.complete()}else try{const f=t.alignImage(e.imageA,l,e.widthA,e.heightA,!1,e.preference.numberofpointToMatch,e.preference.numberofpointToMatch,e.debug);e.imageA=void 0,f.pageNumber=e.pageNumber,a.next(f),a.complete()}catch(f){console.error(f)}}})).catch(s=>{console.log(s)})})}selectTransferables(e){return void 0!==e.imagesDebugTraces?[e.imageAligned,e.imagesDebugTraces]:[e.imageAligned]}imageDataFromMat(e){const t=e,a=e.type()%8,s=a<=cv.CV_8S?1:a<=cv.CV_32S?1/256:255,l=a===cv.CV_8S||a===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,s,l),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const f=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return e.delete(),f}roi(e,t){const a=e.size().width,s=e.size().height;return t.x+t.width>a&&(t.width=a-t.x),t.y+t.height>s&&(t.height=s-t.y),t.x<0&&(t.x=0),t.y<0&&(t.y=0),e.roi(t)}alignImage(e,t,a,s,l,f,R,S){const W=new ImageData(new Uint8ClampedArray(e),a,s),g=t,n=cv.matFromImageData(W);let q=cv.matFromImageData(g),$=q;if(n.size().width!==q.size().width||n.size().height!==q.size().height){$=new cv.Mat;let i=new cv.Size(n.size().width,n.size().height);cv.resize(q,$,i,0,0,cv.INTER_AREA),q.delete()}let F=new cv.Mat,w=new cv.Mat;cv.cvtColor($,F,cv.COLOR_BGRA2GRAY),cv.cvtColor(n,w,cv.COLOR_BGRA2GRAY);const Z=Math.trunc(n.size().width/10);let b=[],P=[],y={},L=!1,N=!1,d=!1,m=!1;const z=Math.min(F.size().width,w.size().width),Y=Math.min(F.size().height,w.size().height);if(l){let i=new cv.Rect(0,0,z,Y);L=this.matchSmallImage(F,w,b,P,i,f,R),N=!0,d=!0,m=!0}else{let i=Z;for(;!L&&i<3*z/4&&i<2*Y/3;){let D=new cv.Rect(0,0,i,i);L=this.matchSmallImage(F,w,b,P,D,f,R),L||(i+=Math.trunc(z/10))}for(i=Z;!N&&i<3*z/4&&i<2*Y/3;){let D=new cv.Rect(z-i,0,z,i);N=this.matchSmallImage(F,w,b,P,D,f,R),N||(i+=Math.trunc(z/10))}for(i=Z;!d&&i<3*z/4&&i<2*Y/3;){let D=new cv.Rect(0,Y-i,i,Y);d=this.matchSmallImage(F,w,b,P,D,f,R),d||(i+=Math.trunc(z/10))}for(i=Z;!m&&i<3*z/4&&i<2*Y/3;){let D=new cv.Rect(z-i,Y-i,z,Y);m=this.matchSmallImage(F,w,b,P,D,f,R),m||(i+=Math.trunc(z/10))}}if(L&&N&&d&&m){let i=cv.matFromArray(b.length/2,1,cv.CV_32FC2,b),D=cv.matFromArray(P.length/2,1,cv.CV_32FC2,P),ee=cv.findHomography(i,D,cv.RANSAC),V=$;if(cv.warpPerspective(V,V,ee,n.size()),S){let k=new cv.MatVector;k.push_back(n),k.push_back($);let r=new cv.Mat;cv.hconcat(k,r);const E=P.length/2;for(let O=0;O<E;O++){let _={x:P[2*O],y:P[2*O+1]},K={x:n.size().width+b[2*O],y:b[2*O+1]};cv.circle(r,_,5,[0,255,0,255],1),cv.circle(r,K,5,[0,255,0,255],1),cv.line(r,_,K,[0,255,0,255],1)}y.imagesDebugTracesWidth=r.size().width,y.imagesDebugTracesHeight=r.size().height,y.imagesDebugTraces=this.imageDataFromMat(r).data.buffer,k.delete()}y.imageAlignedWidth=V.size().width,y.imageAlignedHeight=V.size().height,y.imageAligned=this.imageDataFromMat(V).data.buffer,i.delete(),D.delete(),ee.delete(),t.data.set([])}else{if(S){let i=new cv.MatVector;i.push_back(n),i.push_back($);let D=new cv.Mat;cv.hconcat(i,D),y.imagesDebugTracesWidth=D.size().width,y.imagesDebugTracesHeight=D.size().height,y.imagesDebugTraces=this.imageDataFromMat(D).data.buffer,i.delete()}y.imageAligned=t.data.buffer,y.imageAlignedWidth=t.width,y.imageAlignedHeight=t.height,$.delete()}return W.data.set([]),n.delete(),F.delete(),w.delete(),y}matchSmallImage(e,t,a,s,l,f,R){let S=new cv.Mat;S=this.roi(e,l);let W=new cv.Mat;W=this.roi(t,l);let g=new cv.KeyPointVector,n=new cv.KeyPointVector,q=new cv.Mat,$=new cv.Mat,F=new cv.AKAZE,Z=W;F.detectAndCompute(S,S,g,q),F.detectAndCompute(W,Z,n,$);const b=S.size().width,P=S.size().height;S.delete(),W.delete(),F.delete();let y=new cv.DMatchVector,L=new cv.BFMatcher,N=new cv.DMatchVectorVector;L.knnMatch(q,$,N,2),q.delete(),$.delete();for(let r=0;r<N.size();++r){let E=N.get(r),O=E.get(0),_=E.get(1);void 0!==O&&void 0!==_&&O.distance<=_.distance*parseFloat("0.7")&&y.push_back(O)}if(0===y.size())return g.delete(),n.delete(),N.delete(),y.delete(),L.delete(),!1;let d=[],m=[];for(let r=0;r<y.size();r++)d.push(g.get(y.get(r).queryIdx).pt.x+l.x),d.push(g.get(y.get(r).queryIdx).pt.y+l.y),m.push(n.get(y.get(r).trainIdx).pt.x+l.x),m.push(n.get(y.get(r).trainIdx).pt.y+l.y);let z=0,Y=[];const i=[];for(let r=0;r<y.size();r++){let E=(d[2*r]-m[2*r])*(d[2*r]-m[2*r])+(d[2*r+1]-m[2*r+1])*(d[2*r+1]-m[2*r+1]);E<Math.trunc(3*b/20)*Math.trunc(3*P/20)&&(Y.push(E),z+=1,i.push(r))}const D=this.numAverage(Y);let ee=this.dev(Y);if(ee<1&&(ee=1),z<=f)return g.delete(),n.delete(),N.delete(),y.delete(),L.delete(),!1;let V=0,k=[];for(let r=0;r<i.length;r++){let E=(d[2*i[r]]-m[2*i[r]])*(d[2*i[r]]-m[2*i[r]])+(d[2*i[r]+1]-m[2*i[r]+1])*(d[2*i[r]+1]-m[2*i[r]+1]);E<=D+1*ee&&E>=D-1*ee&&(V+=1,k.push(i[r]))}if(V<=R)return g.delete(),n.delete(),N.delete(),y.delete(),L.delete(),!1;{const r=[],E=[];k.forEach(_=>{E.push((d[2*_]-m[2*_])*(d[2*_]-m[2*_])+(d[2*_+1]-m[2*_+1])*(d[2*_+1]-m[2*_+1]))});const O=this.numAverage(E);return k.sort((_,K)=>Math.abs((d[2*_]-m[2*_])*(d[2*_]-m[2*_])+(d[2*_+1]-m[2*_+1])*(d[2*_+1]-m[2*_+1])-O)-Math.abs((d[2*K]-m[2*K])*(d[2*K]-m[2*K])+(d[2*K+1]-m[2*K+1]*(d[2*K+1]-m[2*K+1]))-O)),r.push(k[0]),r.push(k[1]),r.push(k[2]),r.push(k[3]),r.push(k[4]),r.forEach(_=>{a.push(g.get(y.get(+_).queryIdx).pt.x+l.x),a.push(g.get(y.get(+_).queryIdx).pt.y+l.y),s.push(n.get(y.get(+_).trainIdx).pt.x+l.x),s.push(n.get(y.get(+_).trainIdx).pt.y+l.y)}),g.delete(),n.delete(),N.delete(),y.delete(),L.delete(),!0}}numAverage(e){return e.reduce((t,a)=>t+a,0)/e.length}dev(e){let t=e.reduce((s,l)=>s+l,0)/e.length,a=(e=e.map(s=>(s-t)**2)).reduce((s,l)=>s+l,0);return Math.sqrt(a/e.length)}alignImageBasedOnCircle(e,t,a,s,l,f){const R=new ImageData(new Uint8ClampedArray(e),a,s),S=t;let F,w,Z,b,P,y,L,N,d,m,z,Y,W=cv.matFromImageData(R),g=new cv.Mat,n=new cv.Mat;cv.cvtColor(W,g,cv.COLOR_RGBA2GRAY),cv.HoughCircles(g,n,cv.HOUGH_GRADIENT,1,45,75,20,g.cols*l.minCircle/1e3,g.cols*l.maxCircle/1e3),n.cols>0&&(F=n.data32F[0],w=n.data32F[1],Z=n.data32F[2],b=n.data32F[0],P=n.data32F[1],y=n.data32F[2],L=n.data32F[0],N=n.data32F[1],d=n.data32F[2],m=n.data32F[0],z=n.data32F[1],Y=n.data32F[2]);const i=g.size().width,D=g.size().height;if(n.cols>0)for(let B=1;B<n.cols;B++){let v=n.data32F[3*B],p=n.data32F[3*B+1],J=n.data32F[3*B+2];v*v+p*p<=F*F+w*w&&(F=v,w=p,Z=J),v*v+p*p>=m*m+z*z&&(m=v,z=p,Y=J),(i-v)*(i-v)+p*p<=(i-b)*(i-b)+P*P&&(b=v,P=p,y=J),v*v+(D-p)*(D-p)<=L*L+(D-N)*(D-N)&&(L=v,N=p,d=J)}let ee=cv.matFromImageData(S),V=ee;if(V.size().width!==g.size().width||V.size().height!==g.size().height){V=new cv.Mat;let B=new cv.Size(g.size().width,g.size().height);cv.resize(ee,V,B,0,0,cv.INTER_AREA),ee.delete()}let k=new cv.Mat,r=new cv.Mat;cv.cvtColor(V,k,cv.COLOR_RGBA2GRAY);const E=k.size().width,O=k.size().height;let _=Math.trunc(.8*d);0===_&&(_=1);const K=Math.trunc(1.2*d);cv.HoughCircles(k,r,cv.HOUGH_GRADIENT,1,45,75,15,_,K);let ae=[],pe=[];const Ie=180*(4*d*d-3.14159*d*d)/100;for(let B=0;B<r.cols;B++){let v=r.data32F[3*B],p=r.data32F[3*B+1];const J=v-d,ye=p-d;let ue=2*d,fe=2*d;J+ue>E&&(ue=E-J),ye+fe>O&&(fe=O-ye);let we=new cv.Rect(v-d,p-d,ue,fe),_e=new cv.Mat,te=new cv.Mat;_e=this.roi(k,we),cv.threshold(_e,te,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY),cv.countNonZero(te)<Ie&&(ae.push(v),pe.push(p)),te.delete(),_e.delete()}let se,ne,ce,le,oe,de,he,me;if(ae.length>0&&(se=ae[0],ne=pe[0],ce=ae[0],le=pe[0],oe=ae[0],de=pe[0],he=ae[0],me=pe[0]),ae.length>1)for(let B=0;B<ae.length;B++){let v=ae[B],p=pe[B];v*v+p*p<=se*se+ne*ne&&(se=v,ne=p),v*v+p*p>=he*he+me*me&&(he=v,me=p),(E-v)*(E-v)+p*p<=(E-ce)*(E-ce)+le*le&&(ce=v,le=p),v*v+(O-p)*(O-p)<=oe*oe+(O-de)*(O-de)&&(oe=v,de=p)}if(ae.length>=3){let B=new cv.Size(g.cols,g.rows);const v=se*se+ne*ne,p=(E-ce)*(E-ce)+le*le,J=(O-de)*(O-de)+oe*oe,ye=(O-me)*(O-me)+(E-he)*(E-he);let ue,fe;Math.max(v,p,J,ye)===J?(ue=cv.matFromArray(3,1,cv.CV_32FC2,[F,w,b,P,m,z]),fe=cv.matFromArray(3,1,cv.CV_32FC2,[se,ne,ce,le,he,me])):Math.max(v,p,J,ye)===p?(ue=cv.matFromArray(3,1,cv.CV_32FC2,[F,w,L,N,m,z]),fe=cv.matFromArray(3,1,cv.CV_32FC2,[se,ne,oe,de,he,me])):Math.max(v,p,J,ye)===v?(ue=cv.matFromArray(3,1,cv.CV_32FC2,[b,P,L,N,m,z]),fe=cv.matFromArray(3,1,cv.CV_32FC2,[ce,le,oe,de,he,me])):(ue=cv.matFromArray(3,1,cv.CV_32FC2,[F,w,b,P,L,N]),fe=cv.matFromArray(3,1,cv.CV_32FC2,[se,ne,ce,le,oe,de]));let we=new cv.Mat,_e=cv.getAffineTransform(ue,fe);cv.warpAffine(V,we,_e,B,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);let te={};if(f){let Ae=new cv.MatVector;Ae.push_back(W),Ae.push_back(V);let De=new cv.Size(2*W.size().width,g.size().height),j=new cv.Mat(De,W.type());cv.hconcat(Ae,j);let ie={x:F,y:w},re={x:g.size().width+se,y:ne};cv.circle(j,ie,15,[0,255,0,255],1),cv.circle(j,re,15,[0,255,0,255],1),cv.line(j,ie,re,[0,255,0,255],1),ie={x:b,y:P},re={x:g.size().width+ce,y:le},cv.circle(j,ie,15,[0,255,0,255],1),cv.circle(j,re,15,[0,255,0,255],1),cv.line(j,ie,re,[0,255,0,255],1),ie={x:L,y:N},re={x:g.size().width+oe,y:de},cv.circle(j,ie,15,[0,255,0,255],1),cv.circle(j,re,15,[0,255,0,255],1),cv.line(j,ie,re,[0,255,0,255],1),ie={x:m,y:z},re={x:g.size().width+he,y:me},cv.circle(j,ie,15,[0,255,0,255],1),cv.circle(j,re,15,[0,255,0,255],1),cv.line(j,ie,re,[0,255,0,255],1),te.imagesDebugTracesWidth=j.size().width,te.imagesDebugTracesHeight=j.size().height,te.imagesDebugTraces=this.imageDataFromMat(j).data.buffer,Ae.delete()}return te.imageAlignedWidth=we.size().width,te.imageAlignedHeight=we.size().height,te.imageAligned=this.imageDataFromMat(we).data.buffer,W.delete(),g.delete(),n.delete(),k.delete(),r.delete(),ue.delete(),fe.delete(),V.delete(),_e.delete(),te}return W.delete(),g.delete(),n.delete(),k.delete(),V.delete(),r.delete(),this.alignImage(e,t,a,s,!1,l.numberofpointToMatch,l.numberofgoodpointToMatch,f)}})},55113:(c,T,o)=>{o.d(T,{Nn:()=>x,w0:()=>C});var U=o(84674),M=o(59732),I=o(49039);class C{constructor(h){this.initialTeardown=h,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let h;if(!this.closed){this.closed=!0;const{_parentage:A}=this;if(A)if(this._parentage=null,Array.isArray(A))for(const ge of A)ge.remove(this);else A.remove(this);const{initialTeardown:Me}=this;if((0,U.m)(Me))try{Me()}catch(ge){h=ge instanceof M.B?ge.errors:[ge]}const{_finalizers:ve}=this;if(ve){this._finalizers=null;for(const ge of ve)try{Q(ge)}catch(be){h=h??[],be instanceof M.B?h=[...h,...be.errors]:h.push(be)}}if(h)throw new M.B(h)}}add(h){var A;if(h&&h!==this)if(this.closed)Q(h);else{if(h instanceof C){if(h.closed||h._hasParent(this))return;h._addParent(this)}(this._finalizers=null!==(A=this._finalizers)&&void 0!==A?A:[]).push(h)}}_hasParent(h){const{_parentage:A}=this;return A===h||Array.isArray(A)&&A.includes(h)}_addParent(h){const{_parentage:A}=this;this._parentage=Array.isArray(A)?(A.push(h),A):A?[A,h]:h}_removeParent(h){const{_parentage:A}=this;A===h?this._parentage=null:Array.isArray(A)&&(0,I.P)(A,h)}remove(h){const{_finalizers:A}=this;A&&(0,I.P)(A,h),h instanceof C&&h._removeParent(this)}}function x(H){return H instanceof C||H&&"closed"in H&&(0,U.m)(H.remove)&&(0,U.m)(H.add)&&(0,U.m)(H.unsubscribe)}function Q(H){(0,U.m)(H)?H():H.unsubscribe()}C.EMPTY=(()=>{const H=new C;return H.closed=!0,H})()},79940:(c,T,o)=>{o.d(T,{yG:()=>C});var U=o(50671);function C(x){return(0,U.K)(function M(x){return x[x.length-1]}(x))?x.pop():void 0}},79360:(c,T,o)=>{o.d(T,{e:()=>I});var U=o(84674);function I(C){return X=>{if(function M(C){return(0,U.m)(C?.lift)}(X))return X.lift(function(x){try{return C(x,this)}catch(Q){this.error(Q)}});throw new TypeError("Unable to lift unknown Observable type")}}}},xe={};function u(c){var T=xe[c];if(void 0!==T)return T.exports;var o=xe[c]={exports:{}};return Ce[c].call(o.exports,o,o.exports,u),o.exports}u.m=Ce,u.x=()=>{var c=u.O(void 0,[173,379,592],()=>u(18544));return u.O(c)},c=[],u.O=(T,o,U,M)=>{if(!o){var C=1/0;for(I=0;I<c.length;I++){for(var[o,U,M]=c[I],X=!0,x=0;x<o.length;x++)(!1&M||C>=M)&&Object.keys(u.O).every(ve=>u.O[ve](o[x]))?o.splice(x--,1):(X=!1,M<C&&(C=M));if(X){c.splice(I--,1);var Q=U();void 0!==Q&&(T=Q)}}return T}M=M||0;for(var I=c.length;I>0&&c[I-1][2]>M;I--)c[I]=c[I-1];c[I]=[o,U,M]},u.d=(c,T)=>{for(var o in T)u.o(T,o)&&!u.o(c,o)&&Object.defineProperty(c,o,{enumerable:!0,get:T[o]})},u.f={},u.e=c=>Promise.all(Object.keys(u.f).reduce((T,o)=>(u.f[o](c,T),T),[])),u.u=c=>(592===c?"common":c)+"."+{173:"f188109f3619c2fc",379:"5a2571747190c487",592:"21391bcc31b2b0ae"}[c]+".js",u.miniCssF=c=>{},u.o=(c,T)=>Object.prototype.hasOwnProperty.call(c,T),u.j=729,(()=>{var c;u.tt=()=>(void 0===c&&(c={createScriptURL:T=>T},typeof trustedTypes<"u"&&trustedTypes.createPolicy&&(c=trustedTypes.createPolicy("angular#bundler",c))),c)})(),u.tu=c=>u.tt().createScriptURL(c),u.p="",(()=>{var c={729:1};u.f.i=(M,I)=>{c[M]||importScripts(u.tu(u.p+u.u(M)))};var o=self.webpackChunkgrade_scope_istic=self.webpackChunkgrade_scope_istic||[],U=o.push.bind(o);o.push=M=>{var[I,C,X]=M;for(var x in C)u.o(C,x)&&(u.m[x]=C[x]);for(X&&X(u);I.length;)c[I.pop()]=1;U(M)}})(),(()=>{var c=u.x;u.x=()=>Promise.all([173,379,592].map(u.e,u)).then(c)})(),u.x()})();